{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 111,
   "metadata": {
    "collapsed": true,
    "deletable": true,
    "editable": true
   },
   "outputs": [],
   "source": [
    "import requests\n",
    "import json\n",
    "import hashlib\n",
    "import time\n",
    "url_head=\"https://api.xiaojukeji.com/\"\n",
    "keyFixed = '#otosaas#i.({%yUqW_Klm~juo~LzXdv~<IQvM*se#didi#'\n",
    "keyRealTime = '#otosaas#i.({%yUqW_Klm~juo~LzXdv~<IQvM*se#didi#'\n",
    "partnerId='didi71F49141BF1C936D8523AE03DF767CF8B0273C78FA417B9EDC7D03B212FFF585'\n",
    "KEY=keyRealTime"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "deletable": true,
    "editable": true
   },
   "source": [
    "### 4.安全认证-获取token"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 119,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true,
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'access_token': 'didi114B76F34418AB333F46B9917E30639E5C17B0E3F95D789847BBDB906A461D144BB9BAD7EC340D409310C963A61E43317AD1F7E9FDBD385873769F81EAE442C5',\n",
       " 'expires_in_second': 259200,\n",
       " 'refresh_token': '650d15d403-aa440d57a3-9fa95989d3',\n",
       " 'scope': 'public',\n",
       " 'token_type': 'bearer'}"
      ]
     },
     "execution_count": 119,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# url_head=\"http://123.125.253.6:20001/\"\n",
    "url_tail=\"v1/oauth/token\"\n",
    "data={\n",
    "    \"grant_type\":\"client_credentials\",\n",
    "    \"scope\":\"public\",\n",
    "    \"nostr\":\"1235bc\",\n",
    "     \"_\":time.strftime(\"%Y-%m-%dT%H:%M:%S\")\n",
    "     \n",
    "}\n",
    "md5_str = \"&\".join([k + \"=\" + str(v) for k, v in sorted(data.items())])\n",
    "md5 = hashlib.md5(md5_str.encode('utf-8')).hexdigest()\n",
    "sign = hashlib.md5((md5+KEY).encode('utf-8')).hexdigest()\n",
    "\n",
    "headers={\n",
    "    \"Content-Type\": \"application/json\",\n",
    "    \"Authorization\": \"bearer otosaas|{}\".format(sign)\n",
    "}\n",
    "resp=requests.post(url=url_head+url_tail,\n",
    "                   headers=headers,\n",
    "                   data=json.dumps(data)\n",
    "                  )\n",
    "resp.json()\n",
    "\n",
    "\n",
    "\"fixed\",\"realtime\""
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "deletable": true,
    "editable": true
   },
   "source": [
    "### 4.安全认证-更新token"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 101,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true,
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'access_token': 'didi6F368A415571B2A975DF4ADABFE4C7FA991E3C4EC7F1DC6A84CAA4FA1F926B7DCB3B0ABDC07C835B8CE01B1166E7E2621C966A719F7DD7905CD96DE08F81B017',\n",
       " 'expires_in_second': 259200,\n",
       " 'refresh_token': '6067354314-ed133c3da1-536e795b7f',\n",
       " 'scope': 'public rides.read rides.request',\n",
       " 'token_type': 'bearer'}"
      ]
     },
     "execution_count": 101,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "def token_update(refresh_token):\n",
    "    sign_key=KEY\n",
    "    url_tail=\"v1/oauth/token\"\n",
    "    data={\n",
    "        \"grant_type\":\"refresh_token\",\n",
    "        \"nostr\":\"1235bc\",\n",
    "         \"_\":time.strftime(\"%Y-%m-%dT%H:%M:%S\"),\n",
    "        \"refresh_token\":refresh_token\n",
    "\n",
    "    }\n",
    "    md5_str = \"&\".join([k + \"=\" + str(v) for k, v in sorted(data.items())])\n",
    "    md5 = hashlib.md5(md5_str.encode('utf-8')).hexdigest()\n",
    "    sign = hashlib.md5((md5+sign_key).encode('utf-8')).hexdigest()\n",
    "\n",
    "    headers={\n",
    "        \"Content-Type\": \"application/json\",\n",
    "        \"Authorization\": \"bearer {}|{}\".format('otosaas-rt',sign)\n",
    "    }\n",
    "    resp=requests.post(url=url_head+url_tail,\n",
    "                       headers=headers,\n",
    "                       data=json.dumps(data)\n",
    "                      )\n",
    "    resp_data=resp.json()\n",
    "    return resp_data\n",
    "    access_token=resp_data[\"access_token\"]\n",
    "    refresh_token=resp_data[\"refresh_token\"]\n",
    "    return access_token,refresh_token\n",
    "token_update('19fc0e9dad-86dc4f5416-828cd214d6')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "deletable": true,
    "editable": true
   },
   "source": [
    "### 5.POI地址服务"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 120,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true,
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "[{'address': '地铁13号线',\n",
       "  'displayname': '五道口-地铁站',\n",
       "  'lat': 39.992929,\n",
       "  'lng': 116.337626,\n",
       "  'maptype': 'soso'},\n",
       " {'address': '海淀区成府路28号(五道口城铁站东侧)',\n",
       "  'displayname': '五道口购物中心',\n",
       "  'lat': 39.99239,\n",
       "  'lng': 116.33938,\n",
       "  'maptype': 'soso'},\n",
       " {'address': '海淀区五道口',\n",
       "  'displayname': '五道口',\n",
       "  'lat': 39.99289,\n",
       "  'lng': 116.33766,\n",
       "  'maptype': 'soso'},\n",
       " {'address': '海淀区成府路23号',\n",
       "  'displayname': '北京市五道口工人俱乐部电影院',\n",
       "  'lat': 39.9935,\n",
       "  'lng': 116.33937,\n",
       "  'maptype': 'soso'},\n",
       " {'address': '海淀区展春园西路3号院',\n",
       "  'displayname': '五道口嘉园',\n",
       "  'lat': 39.98993,\n",
       "  'lng': 116.33965,\n",
       "  'maptype': 'soso'},\n",
       " {'address': '海淀区学清路38号金码大厦B座1-4层',\n",
       "  'displayname': '五道口服装市场',\n",
       "  'lat': 40.00157,\n",
       "  'lng': 116.35366,\n",
       "  'maptype': 'soso'},\n",
       " {'address': '海淀区中关村甲3号',\n",
       "  'displayname': '龙湖唐宁ONE',\n",
       "  'lat': 39.98913,\n",
       "  'lng': 116.33429,\n",
       "  'maptype': 'soso'},\n",
       " {'address': '海淀区大运村路',\n",
       "  'displayname': '五道口购物广场',\n",
       "  'lat': 39.98533,\n",
       "  'lng': 116.34025,\n",
       "  'maptype': 'soso'},\n",
       " {'address': '398,专12',\n",
       "  'displayname': '五道口公交场站-公交站',\n",
       "  'lat': 39.988934,\n",
       "  'lng': 116.337616,\n",
       "  'maptype': 'soso'},\n",
       " {'address': '',\n",
       "  'displayname': '五道口-公交站',\n",
       "  'lat': 39.992653,\n",
       "  'lng': 116.33494,\n",
       "  'maptype': 'soso'}]"
      ]
     },
     "execution_count": 120,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "access_token='didi114B76F34418AB333F46B9917E30639E5C17B0E3F95D789847BBDB906A461D144BB9BAD7EC340D409310C963A61E43317AD1F7E9FDBD385873769F81EAE442C5'\n",
    "url_tail=\"v1/poi\"\n",
    "data={\n",
    "    \"city\":\"北京\",\n",
    "    \"sug\":\"五道口\"\n",
    "     }\n",
    "headers={\n",
    "    \"Content-Type\": \"application/x-www-form-urlencoded\",\n",
    "    \"Authorization\": \"Bearer otosaas-rt|{}\".format(access_token)\n",
    "}\n",
    "resp=requests.get(url=url_head+url_tail,\n",
    "                   headers=headers,\n",
    "                   params=data\n",
    "                  )\n",
    "resp.json()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "deletable": true,
    "editable": true
   },
   "source": [
    "### 6.运力类型"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 105,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true,
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'products': [{'car_type': 2,\n",
       "   'display_name': 'normal',\n",
       "   'display_name_cn': '舒适型',\n",
       "   'image_url': 'http://static.xiaojukeji.com/gulfstream/upload/2014/20141028/carLevel_100/car_comfort_small@2x.png',\n",
       "   'product_type': 'private-car',\n",
       "   'ride_type': 'compact',\n",
       "   'seats': 4},\n",
       "  {'car_type': 16,\n",
       "   'display_name': 'business',\n",
       "   'display_name_cn': '六座商务',\n",
       "   'image_url': 'http://static.xiaojukeji.com/gulfstream/upload/2014/20141028/carLevel_400/car_business_small@2x.png',\n",
       "   'product_type': 'private-car',\n",
       "   'ride_type': 'premium',\n",
       "   'seats': 6},\n",
       "  {'car_type': 4,\n",
       "   'display_name': 'grand',\n",
       "   'display_name_cn': '行政级',\n",
       "   'image_url': 'http://static.xiaojukeji.com/gulfstream/upload/2014/20141028/carLevel_200/car_luxury_small@2x.png',\n",
       "   'product_type': 'private-car',\n",
       "   'ride_type': 'luxury',\n",
       "   'seats': 4}]}"
      ]
     },
     "execution_count": 105,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "url_tail=\"v1/products\"\n",
    "data={\n",
    "    \"lat\":39.99239,\n",
    "    \"lng\":116.33938,\n",
    "     }\n",
    "headers={\n",
    "    \"Content-Type\": \"application/x-www-form-urlencoded\",\n",
    "    \"Authorization\": \"Bearer otosaas-rt|{}\".format(access_token)\n",
    "}\n",
    "resp=requests.get(url=url_head+url_tail,\n",
    "                   headers=headers,\n",
    "                   params=data\n",
    "                  )\n",
    "resp.json()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "deletable": true,
    "editable": true
   },
   "source": [
    "### 7.计价规则"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 106,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true,
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "[{'price_details': {'base': 1400,\n",
       "   'cancellation_fee': 500,\n",
       "   'cost_per_distance': 260,\n",
       "   'cost_per_minute': 0,\n",
       "   'currency_code': 'CNY',\n",
       "   'distance_unit': 'km',\n",
       "   'minimum': 1400},\n",
       "  'product_type': 'private-car',\n",
       "  'ride_type': 'compact'},\n",
       " {'price_details': {'base': 1700,\n",
       "   'cancellation_fee': 500,\n",
       "   'cost_per_distance': 450,\n",
       "   'cost_per_minute': 0,\n",
       "   'currency_code': 'CNY',\n",
       "   'distance_unit': 'km',\n",
       "   'minimum': 1700},\n",
       "  'product_type': 'private-car',\n",
       "  'ride_type': 'premium'},\n",
       " {'price_details': {'base': 3500,\n",
       "   'cancellation_fee': 500,\n",
       "   'cost_per_distance': 550,\n",
       "   'cost_per_minute': 0,\n",
       "   'currency_code': 'CNY',\n",
       "   'distance_unit': 'km',\n",
       "   'minimum': 10800},\n",
       "  'product_type': 'private-car',\n",
       "  'ride_type': 'luxury'}]"
      ]
     },
     "execution_count": 106,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "\n",
    "url_tail=\"v1/product/standard\"\n",
    "data={\n",
    "    \"lat\":39.99239,\n",
    "    \"lng\":116.33938,\n",
    "     }\n",
    "headers={\n",
    "    \"Content-Type\": \"application/x-www-form-urlencoded\",\n",
    "    \"Authorization\": \"Bearer otosaas-rt|{}\".format(access_token)\n",
    "}\n",
    "resp=requests.get(url=url_head+url_tail,\n",
    "                   headers=headers,\n",
    "                   params=data\n",
    "                  )\n",
    "resp.json()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 107,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'error': 'code(40314)', 'error_detail': '权限不足'}"
      ]
     },
     "execution_count": 107,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# 8.周边司机\n",
    "url_tail=\"v1/drivers\"\n",
    "data={\n",
    "    \"lat\":39.99239,\n",
    "    \"lng\":116.33938,\n",
    "    \"product_type\":\"private-car\",\n",
    "    \"ride_type\":\"compact\"\n",
    "     }\n",
    "headers={\n",
    "    \"Content-Type\": \"application/x-www-form-urlencoded\",\n",
    "    \"Authorization\": \"Bearer otosaas-rt|{}\".format(access_token)\n",
    "}\n",
    "resp=requests.get(url=url_head+url_tail,\n",
    "                   headers=headers,\n",
    "                   params=data\n",
    "                  )\n",
    "resp.json()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 108,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "[{'estimate_eta': 140, 'product_type': 'private-car', 'ride_type': 'compact'}]"
      ]
     },
     "execution_count": 108,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# 9.预估时间\n",
    "url_tail=\"v1/estimates/time\"\n",
    "data={\n",
    "    \"lat\":39.99239,\n",
    "    \"lng\":116.33938,\n",
    "    \"map_type\":\"baidu\",\n",
    "    \"product_type\":\"private-car\",\n",
    "    \"ride_type\":\"compact\"\n",
    "     }\n",
    "headers={\n",
    "    \"Content-Type\": \"application/x-www-form-urlencoded\",\n",
    "    \"Authorization\": \"Bearer otosaas-rt|{}\".format(access_token)\n",
    "}\n",
    "resp=requests.get(url=url_head+url_tail,\n",
    "                   headers=headers,\n",
    "                   params=data\n",
    "                  )\n",
    "resp.json()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 130,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'didi_oid': 'didiE87AA9BF720828884893C6B67E6EB460989301053D910EB3C3257A6C51F30F88',\n",
       " 'driver': {'lat': 31.274491518661, 'lng': 121.47791895226},\n",
       " 'oid': 'ala102271945949229',\n",
       " 'status': 'Accepted'}"
      ]
     },
     "execution_count": 130,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# 14.司机位置\n",
    "partnerId='didiE87AA9BF720828884893C6B67E6EB460989301053D910EB3C3257A6C51F30F88'\n",
    "url_tail=f\"v1/orders/{partnerId}/location\"\n",
    "headers={\n",
    "    \"Content-Type\": \"application/x-www-form-urlencoded\",\n",
    "    \"Authorization\": \"Bearer otosaas-rt|{}\".format(access_token)\n",
    "}\n",
    "resp=requests.get(url=url_head+url_tail,\n",
    "                   headers=headers)\n",
    "resp.json()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 122,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true,
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'charges': [{'amount': 1700,\n",
       "   'currency': 'CNY',\n",
       "   'description': 'starting price',\n",
       "   'type': 'startPrice'},\n",
       "  {'amount': 66,\n",
       "   'currency': 'CNY',\n",
       "   'description': 'driving fee',\n",
       "   'type': 'drivingFee'},\n",
       "  {'amount': 130,\n",
       "   'currency': 'CNY',\n",
       "   'description': 'low speed fee',\n",
       "   'type': 'lowSpeedFee'}],\n",
       " 'departure_time': '2017-10-17T16:54:32+0800',\n",
       " 'destination': {'lat': '31.271393',\n",
       "  'lng': '121.479154',\n",
       "  'name': '虹口足球场(地铁站)'},\n",
       " 'didi_oid': 'didi71F49141BF1C936D8523AE03DF767CF8B0273C78FA417B9EDC7D03B212FFF585',\n",
       " 'driver': {'car_color': '银',\n",
       "  'cnt_order': 792,\n",
       "  'company': '',\n",
       "  'driver_id': '7ea4c3a2505d036d382958f6b5d1e81b',\n",
       "  'lat': '31.271629731639',\n",
       "  'level': 4.95,\n",
       "  'lng': '121.47384640679',\n",
       "  'name': '李师傅',\n",
       "  'phone_number': 'ZWVQOL5F8D116EC1F66A1461FE6F|1',\n",
       "  'rating': 4.95},\n",
       " 'is_pay': 1,\n",
       " 'map_type': 'soso',\n",
       " 'oid': 'ala102261578022920',\n",
       " 'origin': {'lat': '31.270789',\n",
       "  'lng': '121.473148',\n",
       "  'name': '德必运动Loft国际体育产业园'},\n",
       " 'passenger_phone': '13641656321',\n",
       " 'price': {'amount': 1896,\n",
       "  'currency': 'CNY',\n",
       "  'description': 'total fee',\n",
       "  'type': 'totalFee'},\n",
       " 'process': [{'status': 'Pending', 'time': '2017-10-17T16:54:32+0800'},\n",
       "  {'status': 'Accepted', 'time': '2017-10-17T16:54:35+0800'},\n",
       "  {'status': 'Arrived', 'time': '2017-10-17T17:01:03+0800'},\n",
       "  {'status': 'Charging', 'time': '2017-10-17T17:01:05+0800'},\n",
       "  {'status': 'Finished', 'time': '2017-10-17T17:02:34+0800'}],\n",
       " 'product_type': 'private-car',\n",
       " 'request_time': '2017-10-17T16:54:32+0800',\n",
       " 'ride_type': 'compact',\n",
       " 'status': 'Finished',\n",
       " 'vehicle': {'car_color': '银',\n",
       "  'car_type': '上汽大通G10',\n",
       "  'license_plate': '沪**X991',\n",
       "  'picture_url': ''}}"
      ]
     },
     "execution_count": 122,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# 15.行程详情\n",
    "url_tail=f\"v1/orders/{partnerId}/detail\"\n",
    "headers={\n",
    "    \"Content-Type\": \"application/x-www-form-urlencoded\",\n",
    "    \"Authorization\": \"Bearer otosaas-rt|{}\".format(access_token)\n",
    "}\n",
    "resp=requests.get(url=url_head+url_tail,\n",
    "                   headers=headers)\n",
    "resp.json()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 123,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'charges': [{'amount': 1700,\n",
       "   'currency': 'CNY',\n",
       "   'description': 'starting price',\n",
       "   'type': 'startPrice'},\n",
       "  {'amount': 66,\n",
       "   'currency': 'CNY',\n",
       "   'description': 'driving fee',\n",
       "   'type': 'drivingFee'},\n",
       "  {'amount': 130,\n",
       "   'currency': 'CNY',\n",
       "   'description': 'low speed fee',\n",
       "   'type': 'lowSpeedFee'}],\n",
       " 'create_time': '2017-10-17T16:54:32+0800',\n",
       " 'didi_oid': 'didi71F49141BF1C936D8523AE03DF767CF8B0273C78FA417B9EDC7D03B212FFF585',\n",
       " 'price': {'amount': 1896,\n",
       "  'currency': 'CNY',\n",
       "  'description': 'total fee',\n",
       "  'type': 'totalFee'},\n",
       " 'status': 'Finished'}"
      ]
     },
     "execution_count": 123,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# 16.账单\n",
    "url_tail=f\"v1/orders/{partnerId}/bill\"\n",
    "headers={\n",
    "    \"Content-Type\": \"application/x-www-form-urlencoded\",\n",
    "    \"Authorization\": \"Bearer otosaas-rt|{}\".format(access_token)\n",
    "}\n",
    "resp=requests.get(url=url_head+url_tail,\n",
    "                   headers=headers)\n",
    "resp.json()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 118,
   "metadata": {
    "collapsed": false,
    "deletable": true,
    "editable": true
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'didi_oid': 'didi71F49141BF1C936D8523AE03DF767CF8B0273C78FA417B9EDC7D03B212FFF585',\n",
       " 'msg': 'rating success'}"
      ]
     },
     "execution_count": 118,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# 17.评价司机\n",
    "url_tail=f\"v1/orders/{partnerId}/rating\"\n",
    "headers={\n",
    "    \"Content-Type\": \"application/x-www-form-urlencoded\",\n",
    "    \"Authorization\": \"Bearer otosaas-rt|{}\".format(access_token)\n",
    "}\n",
    "resp=requests.post(url=url_head+url_tail,\n",
    "                   headers=headers,\n",
    "                 data={'rating':4,'comment':'good driver'})\n",
    "resp.json()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "collapsed": true,
    "deletable": true,
    "editable": true
   },
   "outputs": [],
   "source": [
    "# session.didi\n",
    "from path import Path\n",
    "Path('/root/')\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
